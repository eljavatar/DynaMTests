# Defects4J Corpus

When training a language model to generate unit tests, it can be useful to have a way to test if the unit tests generated by the model are correct or not, and for this, it is required that there is a way to run them in order to validate if they compile, execute the asserts correctly, what percentage of coverage they achieve, among others.

For this reason we built a corpus from the Defects4J dataset, since in addition to providing a list of projects from which the focal methods and their respective context (either focal or dynamic) can be extracted, it also provides a framework through which unit tests generated by a model can be executed.


## Description

[Defects4J](https://github.com/rjust/defects4j/tree/v2.0.1) is a dataset that collects bug information for 17 Java projects. Each project consists of several bugs, so that for each bug we have two versions of the project: one version with the bug active and another version with the bug fixed.

To build our corpus from the Defects4J dataset and using our approach of extracting the dynamic context of each focal method, only the versions with the fixed bugs were taken into account. For each bug, Defects4J contains information about the classes that were modified to fix it, and thus, we built this corpus by extracting the focal methods only from those modified classes.


## Accessing via Git LFS

The repository makes use of the Git large file storage (LFS) service. Git LFS does replacing large files in the repository with tiny pointer files. To pull the actual files do:

```shell
# first, clone the repo
git clone git@github.com:eljavatar/DynaMTests.git
# next, change to the DynaMTests folder
cd DynaMTests
# finally, pull the files
git lfs pull
```

The Defects4J corpus we built is located in the [defects4j_corpus](defects4j_corpus) folder of this repository, however, in case you want to build a new one (for example with new versions of Defects4J, or using other focal classes), the following is the process we followed to build it.



## How to replicate the Corpus Construction process?

To build the corpus it is necessary to make the necessary configurations to be able to use the commands of the framework provided by Defects4J. For this there are two options:

1. **Configuration from scratch:** for this option, you must access the [Defects4J](https://github.com/rjust/defects4j/tree/v2.0.1) repository, and follow the instructions detailed there. In our case we use version `2.0.1` (although Defects4J already has 3.x.x versions which support Java 11).

2. **Use our Docker image:** We have created a docker image which contains the necessary dependencies and scripts that we use to generate this corpus. To download our docker image, use the following instruction:

```shell
docker pull eljavatar/d4j_tests_benchmark:version11
```


### Required dependencies

When using our docker image, the following dependencies are already included in that image. However, in case you have configured Defects4J from scratch, you must have the following dependencies installed:

- Python >= 3.9
- Git >= 2.34

```shell
# Python dependencies
pip install pandas
pip install scikit-learn
pip install packaging
pip install command-runner
pip install GitPython
pip install tree-sitter==0.21.0
pip install tree-sitter-java==0.21.0
```

In addition, we recommend creating the following folder structure where the scripts found in this repository should be placed since they are the ones we use in the following steps (As mentioned above, these folders and scripts are already included in our docker image):

```shell
# Create the folder /DynaMTests
cd /
mkdir /DynaMTests
The scripts that must be in this folder are the following:
- analize_tokens_corpus.py
- build_corpus_d4j.py
- ClassParser.py
- compress_folder.py
- dependency_parser_utils.py
- DependencyClassParser.py
- extract_classes_info_d4j.py
- ParserUtils.py


# Create the folder /defects4j/framework/custom
cd /defects4j/framework
mkdir custom
# In this folder should be copied the files found in the 'd4_utils' folder of this repository
```


### Download bugfix versions

As mentioned above, Defects4J contains a database of reported bugs and bug fix versions. Each version of a fixed bug represents a commit to a repository on GitHub, through which you can get all the files that the repository had at that time.

Thus, through the following instructions you can download each version of each of the projects in the Defects4J dataset:

```shell
# Locate in the folder /defects4j/framework/custom
cd /defects4j/framework/custom
# Execute the following Script:
./export_revisions.sh
```

The execution of this script will create the `/defects4j_revisions` folder, inside which a list of folders will be located, where each folder is a complete repository representing a version of a bug fixed for a certain project.


### Extraction of focal classes

To build the corpus, the focal methods and their respective context must be selected. One could choose all classes from all versions, or use some other way, however, as mentioned above, for each version of a bug fixed, Defects4J indicates the classes that were modified to fix that bug.

Therefore, the criterion we used to obtain the focal classes was to select those that were modified in each version, and from these, to obtain the focal methods. Through the following instructions the focal classes would be extracted for each version of each project:

```shell
# Locate in the folder /defects4j/framework/custom
cd /defects4j/framework/custom
# Execute the following Script:
./export_focal_classes.sh
```

Executing this script will result in the creation of a json file inside the `/defects4j/framework/custom` folder, which will be named `focal_classes.json`.


### Extract focal methods and their context

The next step is to analyze each of the versions to obtain the focal methods of the previously obtained classes, in order to add to each focal method both its focal context and its dynamic context. For this, the following instructions are executed:

```shell
cd /
mkdir defects4j_with_dynamtests
# Locate in the folder /DynaMTests
cd /DynaMTests
# Execute the following Script:
python3 extract_classes_info_d4j.py \
	--repos_path "/defects4j_revisions" \
	--project_id "all" \
	--focal_classes_json_file "/defects4j/framework/custom/focal_classes.json" \
	--test_and_src_paths_json_file "/defects4j/framework/custom/test_and_src_paths_by_project.json" \
	--output "/defects4j_with_dynamtests/mining" \
	--output_empty "/defects4j_with_dynamtests/mining_empty"
```

The execution of this script will be saved in the `/defects4j_with_dynamtests/mining` folder, where a list of folders will be located, so that each folder will contain the information of the focal methods that have been extracted for each version of each project.


### Corpus generation

From the previously extracted data, the corpus is generated. First, the data are generated in json and raw formats. In addition, a folder named `data_by_project_and_version` will also be created inside the corpus folder, which will be used later to generate the corpus in csv format. For this, the following instructions are followed:

```shell
# Locate in the folder /DynaMTests
cd /DynaMTests
# Execute the following Script:
python3 build_corpus_d4j.py \
	--input_dataset "/defects4j_with_dynamtests/mining" \
	--input_encoding "utf-8" \
	--project_id "all" \
	--output_corpus "/defects4j_with_dynamtests/corpus"
```

Finally, to generate the corpus in csv format, the following instructions are followed:

```shell
# Locate in the folder /defects4j/framework/custom
cd /defects4j/framework/custom
# Execute the following Script:
./build_all_csv_corpus_d4j.sh \
	-d /defects4j_with_dynamtests/corpus/data_by_project_and_version \
	-o /defects4j_with_dynamtests/corpus/csv \
	-t /tmp/checkouts
```

